rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // 1. User Profiles
    match /users/{userId} {
      // Anyone can read a profile (to search and see name/avatar)
      allow read: if request.auth != null;
      // Only the user themselves can write/update their profile
      allow write, update: if request.auth != null && request.auth.uid == userId;
      
      // FCM Tokens subcollection
      match /fcmTokens/{tokenId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // 2. Chats
    match /chats/{chatId} {
      // Only members of the chat can read it
      allow read: if request.auth != null && request.auth.uid in resource.data.members;
      
      // Creation: must be a member being added
      allow create: if request.auth != null && request.auth.uid in request.resource.data.members;
      
      // Update: members can update typing status or unread counts
      allow update: if request.auth != null && request.auth.uid in resource.data.members;
      
      // Deletion: typically groups or conversations can be deleted by members
      allow delete: if request.auth != null && request.auth.uid in resource.data.members;

      // 3. Messages Subcollection
      match /messages/{messageId} {
        // Can read if you're a member of the parent chat
        allow read: if request.auth != null && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.members;
        
        // Can create if you're a member and you are the sender
        allow create: if request.auth != null && 
                      request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.members &&
                      request.resource.data.uid == request.auth.uid;
                      
        // Can delete if you're the sender
        allow delete: if request.auth != null && resource.data.uid == request.auth.uid;
        
        // Can update 'read' status if you are a member
        allow update: if request.auth != null && 
                      request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.members &&
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']);
      }
    }
  }
}
